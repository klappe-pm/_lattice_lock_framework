name: Testing Program Pipeline

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      run_e2e:
        description: 'Run E2E tests'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  # ============================================
  # Stage 1: Quick Quality Gates (< 2 min)
  # ============================================
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    outputs:
      quality_passed: ${{ steps.quality.outcome == 'success' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Quality checks
        id: quality
        run: |
          echo "::group::Ruff Lint"
          ruff check src/ tests/ --config pyproject.toml
          echo "::endgroup::"

          echo "::group::Black Format"
          black --check src/ tests/ --config pyproject.toml
          echo "::endgroup::"

          echo "::group::isort Check"
          isort --check-only src/ tests/ --settings-path pyproject.toml
          echo "::endgroup::"

      - name: Type Check
        run: |
          echo "::group::MyPy"
          mypy src/lattice_lock --no-error-summary || echo "MyPy issues found (non-blocking)"
          echo "::endgroup::"
        continue-on-error: true

  # ============================================
  # Stage 2: Unit Tests with Coverage (90% target)
  # ============================================
  unit-tests:
    name: Unit Tests (Coverage 90%)
    needs: quality-gates
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run Unit Tests with Coverage
        run: |
          pytest tests/ \
            -m "not integration and not e2e and not slow" \
            --cov=src/lattice_lock \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=90 \
            -v \
            --tb=short

      - name: Upload Coverage Report
        if: matrix.python-version == '3.11'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

  # ============================================
  # Stage 3: Documentation Tests
  # ============================================
  documentation-tests:
    name: Documentation Tests
    needs: quality-gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run Documentation Tests
        run: |
          pytest tests/documentation/ -v --tb=short -m documentation || true
          echo "Documentation tests completed"

  # ============================================
  # Stage 4: Quality Tests
  # ============================================
  quality-tests:
    name: Quality Tests
    needs: quality-gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run Quality Tests
        run: |
          pytest tests/quality/ -v --tb=short -m quality

  # ============================================
  # Stage 5: Agent Tests
  # ============================================
  agent-tests:
    name: Agent Tests
    needs: quality-gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Validate Agent Definitions
        run: |
          if [ -f scripts/validate_agents.py ]; then
            python scripts/validate_agents.py
          fi

      - name: Run Agent Tests
        run: |
          pytest tests/agents/ -v --tb=short -m agent || true
          pytest tests/quality/test_agent_settings.py -v --tb=short || true

  # ============================================
  # Stage 6: Security Tests
  # ============================================
  security-tests:
    name: Security Tests
    needs: quality-gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
          pip install bandit safety

      - name: Bandit Security Scan
        run: |
          bandit -r src/lattice_lock -ll -x tests --format json --output bandit-report.json || true
          bandit -r src/lattice_lock -ll -x tests

      - name: Safety Dependency Check
        run: |
          safety check --full-report || true

      - name: Run Security Tests
        run: |
          pytest tests/security/ -v --tb=short -m security || true

      - name: Upload Security Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: bandit-report.json
          if-no-files-found: ignore

  # ============================================
  # Stage 7: Integration Tests
  # ============================================
  integration-tests:
    name: Integration Tests
    needs: [unit-tests]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run Integration Tests
        run: |
          pytest tests/integration/ -v --tb=short -m integration --timeout=120

  # ============================================
  # Stage 8: Approver Agent Review
  # ============================================
  approver-review:
    name: Approver Agent Review
    needs: [unit-tests, documentation-tests, quality-tests, security-tests]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Download Coverage Report
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: .
        continue-on-error: true

      - name: Run Approver Agent
        id: approver
        run: |
          python -c "
          from lattice_lock.agents.approver import ApproverAgent
          from lattice_lock.agents.settings import reset_settings

          reset_settings()
          try:
              agent = ApproverAgent()
              result = agent.review(pr_number=${{ github.event.pull_request.number }})
              print(result.to_markdown())

              # Write result to file for PR comment
              with open('approver-result.md', 'w') as f:
                  f.write(result.to_markdown())

              # Exit based on approval status
              import sys
              sys.exit(0 if result.approved else 1)
          except Exception as e:
              print(f'Approver Agent error: {e}')
              # Don't block on approver errors during initial rollout
              import sys
              sys.exit(0)
          "
        continue-on-error: true

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = '## Approver Agent Review\n\nApprover Agent review completed. Check workflow logs for details.';

            try {
              if (fs.existsSync('approver-result.md')) {
                body = fs.readFileSync('approver-result.md', 'utf8');
              }
            } catch (e) {
              console.log('Could not read approver result:', e);
            }

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c => c.body.includes('Approver Agent Review'));

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # ============================================
  # Final: Summary
  # ============================================
  summary:
    name: Pipeline Summary
    needs: [quality-gates, unit-tests, documentation-tests, quality-tests, agent-tests, security-tests, integration-tests]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check Results
        run: |
          echo "## Testing Program Pipeline Results"
          echo ""
          echo "| Stage | Status |"
          echo "|-------|--------|"
          echo "| Quality Gates | ${{ needs.quality-gates.result }} |"
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |"
          echo "| Documentation Tests | ${{ needs.documentation-tests.result }} |"
          echo "| Quality Tests | ${{ needs.quality-tests.result }} |"
          echo "| Agent Tests | ${{ needs.agent-tests.result }} |"
          echo "| Security Tests | ${{ needs.security-tests.result }} |"
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |"

          # Fail if critical stages failed
          if [ "${{ needs.quality-gates.result }}" == "failure" ]; then
            echo "::error::Quality gates failed"
            exit 1
          fi

          if [ "${{ needs.unit-tests.result }}" == "failure" ]; then
            echo "::error::Unit tests failed"
            exit 1
          fi
