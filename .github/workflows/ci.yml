name: Production CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  policy:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR targets main and has required labels
        env:
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          set -euo pipefail
          base_ref=$(jq -r '.pull_request.base.ref' "$GITHUB_EVENT_PATH")
          if [ "$base_ref" != "main" ]; then
            echo "::error::PRs must target base branch 'main' (found '$base_ref')"; exit 1
          fi
          mapfile -t labels < <(jq -r '.pull_request.labels[].name' "$GITHUB_EVENT_PATH")
          has_scope=false
          has_source=false
          shopt -s nocasematch
          for l in "${labels[@]:-}"; do
            [[ "$l" =~ ^(feat|fix|chore|docs|refactor)$ || "$l" =~ ^scope:\ *(feat|fix|chore|docs|refactor)$ ]] && has_scope=true
            [[ "$l" =~ ^(human|llm|devin)$ || "$l" =~ ^source:\ *(human|llm|devin)$ ]] && has_source=true
          done
          shopt -u nocasematch
          if [ "$has_scope" != true ]; then
            echo "::error::Missing scope label. Add one of: feat, fix, chore, docs, refactor (or 'scope: ...')."; exit 1
          fi
          if [ "$has_source" != true ]; then
            echo "::error::Missing source label. Add one of: human, llm, devin (or 'source: ...')."; exit 1
          fi
          echo "::notice::PR policy checks passed"

  quality:
    needs: [policy]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ["3.10", "3.11", "3.12"]

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pip-tools
        pip install -e .[dev]

    - name: Lint (Ruff)
      run: ruff check .

    - name: Format Check (Black)
      run: black --check .

    - name: Type Check (MyPy)
      run: mypy src/lattice_lock

    - name: Security Check (Bandit)
      run: |
        pip install bandit
        bandit -r src/lattice_lock -c pyproject.toml || true

  test:
    needs: quality
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6
    - uses: actions/setup-python@v6
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: Install dependencies
      run: pip install -e .[dev]

    - name: Run Tests
      run: pytest tests/ -m "not integration" --cov=src/lattice_lock --cov-report=xml

    - name: Verify Secrets Script
      run: |
        if [ -f scripts/check_secrets.py ]; then
          python scripts/check_secrets.py
        fi

    - name: Verify Version Sync
      run: |
        # Ensure __init__.py version matches pyproject.toml
        ./scripts/update_version.sh
        if ! git diff --quiet src/lattice_lock/__init__.py; then
          echo "::error::Version mismatch! src/lattice_lock/__init__.py path does not match pyproject.toml"
          echo "Run ./scripts/update_version.sh to fix."
          exit 1
        fi
