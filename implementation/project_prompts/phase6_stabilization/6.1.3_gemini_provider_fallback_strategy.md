# Provider Client and Fallback Strategy Design

**Task ID:** 6.1.3
**Phase:** 6.1 (Breaking Issues / Orchestrator Contract Hardening)
**Author:** Gemini Antimatter
**Status:** Approved Design

## 1. Overview
The framework supports 8 model providers with varying levels of implementation maturity. This design formalizes the "Maturity Tier" concept to manage user expectations and prevent runtime crashes (like the `BedrockClient` NotImplementedError). It also robustifies fallback logic.

## 2. Provider Maturity Classification

We introduce a `ProviderMaturity` enum to classify stability.

| Tier | Definition | User Experience |
| :--- | :--- | :--- |
| **PRODUCTION** | Fully tested, stable, 99.9% uptime expected. | Enabled by default if credentials exist. |
| **BETA** | Feature complete but less battle-tested. | Enabled by default, warns on first use. |
| **EXPERIMENTAL** | Partial implementation, api flux. | **Disabled by default.** Must opt-in via config. |

### 2.1 Provider Classifications

| Provider | Current Status | Tier | Notes |
| :--- | :--- | :--- | :--- |
| `openai` | Implemented | **PRODUCTION** | Primary default. |
| `anthropic` | Implemented | **PRODUCTION** | Strong secondary. |
| `ollama` | Implemented | **BETA** | Local inference, widely used. |
| `google` | Partial | **BETA** | Needs rigorous testing. |
| `xai` | Partial | **EXPERIMENTAL** | API unstable. |
| `azure` | Partial | **BETA** | Enterprise adoption strong. |
| `bedrock` | **Not Implemented** | **EXPERIMENTAL** | **Currently raising errors.** |
| `dial` | Partial | **EXPERIMENTAL** | Custom enterprise wrapper. |

## 3. Handling AWS Bedrock
**Decision:** **Option B (Gate behind Feature Flag).**
We will NOT remove it from the registry, but we will mark it as `EXPERIMENTAL` and ensure the `BedrockClient` checks for the feature flag before raising `NotImplementedError`.

**Implementation:**
The `Orchestrator` will filter out experimental providers unless `enable_experimental_providers: true` is set in `lattice.yaml` or ENV var.

## 4. Required Environment Variables

The system will enforce these credentials at startup *only* for enabled providers.

| Provider | Required Env Var(s) | Validation Action |
| :--- | :--- | :--- |
| OpenAI | `OPENAI_API_KEY` | Log warning, disable provider. |
| Anthropic | `ANTHROPIC_API_KEY` | Log warning, disable provider. |
| Google | `GOOGLE_API_KEY` | Log warning, disable provider. |
| Azure | `AZURE_OPENAI_KEY`, `AZURE_ENDPOINT` | Log warning, disable provider. |
| Bedrock | `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY` | Log warning, disable provider. |
| XAI | `XAI_API_KEY` | Log warning, disable provider. |
| DIAL | `DIAL_API_KEY`, `DIAL_URL` | Log warning, disable provider. |

**Validation Logic:**
At Orchestartor initialization, `ProviderAvailability.check_all_providers()` runs. It checks env vars.
*   **Missing Vars:** Provider status set to `UNAVAILABLE`.
*   **Result:** Models from unavailable providers are effectively invisible to the routing logic.

## 5. Fallback Behavior Strategy

### 5.1 Automatic Fallback Chain
When a model call fails (500 error, rate limit, timeout):
1.  Log error.
2.  Consult `ProviderAvailability`.
3.  Select next best model (by `ModelScorer`) ensuring:
    *   Provider is `AVAILABLE`.
    *   Provider is not the one that just failed (unless it was a model-specific error).
    *   Provider is not `EXPERIMENTAL` (unless opted in).

### 5.2 Explicit Selection vs. Routing
*   **Explicit Selection** (`route --model claude-3-opus`): If credentials missing -> **HARD FAIL** (Raise `ProviderUnavailableError`). User asked for specific tool, we must tell them why it can't run.
*   **Automatic Routing** (`route "help me"`): If OpenAI missing -> **SILENT SKIP** -> Try Anthropic. User just wants a result.

## 6. Provider Health Checks

### 6.1 Startup Check
On `ModelOrchestrator.__init__`:
1.  Iterate all registered providers.
2.  Check for presence of Env Vars.
3.  Update internal `_provider_status` map.

### 6.2 Runtime Health (Circuit Breaker)
If a provider returns 3 consecutive connection errors within 1 minute:
1.  Mark provider as `DEGRADED`.
2.  Temporarily deprioritize in `ModelScorer` (penalty -50%).
3.  After 5 minutes, attempt "canary" request (allow 1 call through).
4.  If success, reset to `AVAILABLE`.

## 7. Implementation Tasks (Devin AI)

1.  **Modify `src/lattice_lock_orchestrator/api_clients.py`**:
    *   Add `ProviderMaturity` Enum.
    *   Update `BedrockClient` to respect experimental flag.
    *   Implement Circuit Breaker logic in base `APIClient`.
2.  **Modify `src/lattice_lock_orchestrator/registry.py`**:
    *   Add `maturity` field to `ModelCapabilities`.
3.  **Update `core.py`**:
    *   Update fallback logic to skip experimental providers by default.
4.  **Tests**:
    *   `tests/test_fallback.py`: Simulate provider failure and verify switch.
    *   `tests/test_bedrock_gate.py`: Ensure Bedrock doesn't crash unless explicitly enabled.
