# Task 6.3.3 - Cost & Telemetry Strategy Design

**Tool:** Gemini Antimatter (Design Doc)
**Phase:** 6.3 - Orchestrator Feature Completeness
**Dependencies:** None (can run parallel with 6.3.1)
**Owner:** Gemini Antimatter

---

## Prompt for Gemini Antimatter

You are helping maintain architectural documentation for the lattice-lock-framework.

Task ID: 6.3.3 - Cost & Telemetry Strategy Design

### Context

The framework claims cost tracking capability, but:
- `show_cost_report()` in CLI returns "not yet implemented in v3.1"
- No actual cost tracking infrastructure exists
- Model costs are defined but not tracked

**Current State:**
- `ModelCapabilities.cost_per_1k_tokens` exists
- No storage for usage data
- No aggregation logic

### Goals

Write a design document covering:

1. **Cost Tracking Scope**
   - Per-call tracking: tokens in, tokens out, cost
   - Per-session aggregation: total cost for session
   - Per-model breakdown: cost by model
   - Per-provider breakdown: cost by provider
   - Time-based reporting: daily, weekly, monthly

2. **Data Model**
   ```python
   @dataclass
   class UsageRecord:
       timestamp: datetime
       model_id: str
       provider: str
       input_tokens: int
       output_tokens: int
       cost: float
       request_id: str
       task_type: TaskType
   ```

3. **Storage Strategy**
   Options to evaluate:
   - In-memory only (lost on restart)
   - SQLite file (persistent, simple)
   - JSON file (human-readable)
   - External database (PostgreSQL)
   
   Recommendation with rationale

4. **API Surface**
   ```python
   class CostTracker:
       def record_usage(self, record: UsageRecord) -> None
       def get_session_cost(self) -> float
       def get_cost_by_model(self) -> dict[str, float]
       def get_cost_by_provider(self) -> dict[str, float]
       def get_cost_report(self, start: datetime, end: datetime) -> CostReport
       def export_csv(self, path: str) -> None
   ```

5. **CLI Commands**
   - `orchestrator_cli.py cost` - Show current session cost
   - `orchestrator_cli.py cost --detailed` - Show breakdown
   - `orchestrator_cli.py cost --export costs.csv` - Export data

6. **Integration Points**
   - Where in `core.py` to record usage
   - How to get token counts from API responses
   - Handling providers that don't return token counts

7. **Unknown Cost Handling**
   - What to do when cost_per_1k is unknown
   - Estimation strategies
   - User warnings

8. **Implementation Tasks**
   List concrete tasks for Devin AI:
   - Files to create
   - Integration points
   - Tests to write

### Reference Files

- `src/lattice_lock_orchestrator/core.py` - Where to integrate
- `src/lattice_lock_orchestrator/types.py` - Existing types
- `scripts/orchestrator_cli.py` - CLI to update
