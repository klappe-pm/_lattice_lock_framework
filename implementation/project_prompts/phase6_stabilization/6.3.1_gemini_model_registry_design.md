# Model Registry Source-of-Truth Design

**Task ID:** 6.3.1
**Phase:** 6.3 (Orchestrator Feature Completeness)
**Author:** Gemini Antimatter
**Status:** Approved Design

## 1. Overview
The current hardcoded model registry scales poorly and makes it difficult to update model pricing or capabilities without re-deploying code. This design moves the "source of truth" to an external configuration file `models/model_registry.yaml`.

## 2. Registry Source of Truth

**Decision:** Use **YAML** (`models/model_registry.yaml`) as the definitive source.
*   **Why YAML?** Readable, supports comments, widely supported.
*   **Syncing:** The `model_registry.md` documentation should be auto-generated from this YAML file (future CI task).

## 3. Registry Schema

The `models/model_registry.yaml` file follows this structure:

```yaml
version: "1.0"
models:
  - id: "gpt-4-turbo-2024-04-09"
    api_name: "gpt-4-turbo"  # Actual string sent to API
    provider: "openai"
    display_name: "GPT-4 Turbo"
    description: "High-intelligence flagship model."
    context_window: 128000
    max_output_tokens: 4096
    
    # Cost per 1M tokens (Standard) or 1k (Legacy - we use 1k internally)
    cost_per_1k_input: 0.01
    cost_per_1k_output: 0.03
    
    capabilities:
      coding_score: 93.0
      reasoning_score: 95.0
      supports_vision: true
      supports_function_calling: true
      supports_json_mode: true
    
    status: "production" # production, beta, experimental, deprecated
    min_api_version: "2024-04-09"

  - id: "claude-3-opus-20240229"
    api_name: "claude-3-opus-20240229"
    provider: "anthropic"
    display_name: "Claude 3 Opus"
    # ...
```

## 4. Loading Strategy

### 4.1 Initialization
The `ModelRegistry` class in `src/lattice_lock_orchestrator/registry.py` will:
1.  Check for `models/model_registry.yaml` (relative to project root).
2.  If found: Load and parse.
3.  If not found: Fallback to internal hardcoded defaults (for backward compatibility during migration).

### 4.2 Validation
Upon loading, the registry **MUST** validate:
*   `id` is unique.
*   `provider` is a valid `Provider` enum value.
*   `status` is valid.
*   Costs are non-negative.

### 4.3 Caching
Registry data is cached in memory as a `Dict[str, ModelCapabilities]` upon first access (Lazy Loading).

## 5. Model Status Semantics

To assist the `Orchestrator` in routing:
*   **`production`**: Preferred for automatic routing.
*   **`beta`**: Available for automatic routing, but lowers priority score slightly.
*   **`experimental`**: Excluded from automatic routing unless explicitly requested or `enable_experimental` is set.
*   **`deprecated`**: Log warning when used.

## 6. Implementation Tasks (Devin AI)

1.  **Create `models/model_registry.yaml`**:
    *   Populate with the 63 models currently listed in `models/model_registry.md`.
    *   Ensure pricing is up to date.
2.  **Update `src/lattice_lock_orchestrator/registry.py`**:
    *   Add YAML loading logic (requires `PyYAML`).
    *   Update `get_model` to query loaded data.
    *   Retain hardcoded list as fallback for now (or move to `defaults.py`).
3.  **Tests**:
    *   `tests/test_registry_loading.py`: Mock YAML file and verify model loading.
    *   `tests/test_registry_validation.py`: Ensure malformed YAML raises errors.
