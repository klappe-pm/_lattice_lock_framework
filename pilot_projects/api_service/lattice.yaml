# Lattice Lock Schema Definition for API Service Pilot Project
# This schema defines the entities for a REST API service with
# user authentication, product inventory, orders, and payments.

version: v2.1
generated_module: api_service_types

database:
  backend: postgresql
  connection_string: ${DATABASE_URL}

entities:
  User:
    description: "User account with authentication credentials"
    fields:
      id: int
      email: str
      password_hash: str
      first_name: str
      last_name: str
      is_active: bool
      is_verified: bool
      created_at: datetime
      updated_at: datetime
    constraints:
      id: {primary_key: true, auto_increment: true}
      email: {unique: true, max_length: 255}
      password_hash: {min_length: 60, max_length: 60}
      first_name: {max_length: 100}
      last_name: {max_length: 100}
    ensures:
      - "email contains '@'"
      - "email contains '.'"
      - "len(password_hash) == 60"
    indexes:
      - {fields: [email], unique: true}
      - {fields: [is_active]}

  Product:
    description: "Product in the inventory catalog"
    fields:
      id: int
      sku: str
      name: str
      description: str
      price_cents: int
      quantity_in_stock: int
      category: str
      is_available: bool
      created_at: datetime
      updated_at: datetime
    constraints:
      id: {primary_key: true, auto_increment: true}
      sku: {unique: true, max_length: 50}
      name: {max_length: 200}
      price_cents: {gte: 0}
      quantity_in_stock: {gte: 0}
      category: {max_length: 100}
    ensures:
      - "price_cents >= 0"
      - "quantity_in_stock >= 0"
      - "len(sku) >= 3"
    indexes:
      - {fields: [sku], unique: true}
      - {fields: [category]}
      - {fields: [is_available]}

  Order:
    description: "Customer order with status workflow"
    fields:
      id: int
      user_id: int
      status: str
      total_cents: int
      shipping_address: str
      billing_address: str
      notes: str
      created_at: datetime
      updated_at: datetime
    constraints:
      id: {primary_key: true, auto_increment: true}
      user_id: {foreign_key: User.id}
      status: {enum: [pending, confirmed, processing, shipped, delivered, cancelled]}
      total_cents: {gte: 0}
      shipping_address: {max_length: 500}
      billing_address: {max_length: 500}
    ensures:
      - "total_cents >= 0"
      - "status in ['pending', 'confirmed', 'processing', 'shipped', 'delivered', 'cancelled']"
    indexes:
      - {fields: [user_id]}
      - {fields: [status]}
      - {fields: [created_at]}

  OrderItem:
    description: "Line item in an order"
    fields:
      id: int
      order_id: int
      product_id: int
      quantity: int
      unit_price_cents: int
      created_at: datetime
    constraints:
      id: {primary_key: true, auto_increment: true}
      order_id: {foreign_key: Order.id}
      product_id: {foreign_key: Product.id}
      quantity: {gt: 0}
      unit_price_cents: {gte: 0}
    ensures:
      - "quantity > 0"
      - "unit_price_cents >= 0"
    indexes:
      - {fields: [order_id]}
      - {fields: [product_id]}

  Payment:
    description: "Payment transaction for an order"
    fields:
      id: int
      order_id: int
      amount_cents: int
      currency: str
      status: str
      payment_method: str
      transaction_id: str
      created_at: datetime
      processed_at: datetime
    constraints:
      id: {primary_key: true, auto_increment: true}
      order_id: {foreign_key: Order.id}
      amount_cents: {gt: 0}
      currency: {enum: [USD, EUR, GBP, CAD]}
      status: {enum: [pending, processing, completed, failed, refunded]}
      payment_method: {enum: [credit_card, debit_card, paypal, bank_transfer]}
      transaction_id: {unique: true, max_length: 100}
    ensures:
      - "amount_cents > 0"
      - "currency in ['USD', 'EUR', 'GBP', 'CAD']"
      - "status in ['pending', 'processing', 'completed', 'failed', 'refunded']"
    indexes:
      - {fields: [order_id]}
      - {fields: [transaction_id], unique: true}
      - {fields: [status]}

validation:
  strict_mode: true
  fail_fast: false
  generate_contracts: true
