# Lattice Lock Schema Definition for Data Pipeline Pilot Project
# This schema defines the entities for a data processing pipeline with
# extraction, transformation, loading, and validation stages.

version: v2.1
generated_module: data_pipeline_types

database:
  backend: postgresql
  connection_string: ${DATABASE_URL}

entities:
  DataSource:
    description: "Configuration for a data extraction source"
    fields:
      id: {type: int, primary_key: true}
      name: {type: str, unique: true}
      source_type: {enum: [database, api, file, stream]}
      connection_config: {type: str}
      schema_definition: {type: str}
      is_active: {type: bool, default: true}
      last_sync_at: {type: str, nullable: true}
      created_at: {type: str}
      updated_at: {type: str}
    indexes:
      - {fields: [name], unique: true}
      - {fields: [source_type]}
      - {fields: [is_active]}

  DataRecord:
    description: "Individual data record extracted from a source"
    fields:
      id: {type: int, primary_key: true}
      source_id: {type: int}
      record_key: {type: str}
      raw_data: {type: str}
      extracted_at: {type: str}
      status: {enum: [pending, extracted, transformed, loaded, failed], default: pending}
      error_message: {type: str, nullable: true}
      created_at: {type: str}
    indexes:
      - {fields: [source_id]}
      - {fields: [record_key]}
      - {fields: [status]}
      - {fields: [extracted_at]}

  TransformationRule:
    description: "Rule defining how to transform data"
    fields:
      id: {type: int, primary_key: true}
      name: {type: str, unique: true}
      source_field: {type: str}
      target_field: {type: str}
      transform_type: {enum: [map, filter, aggregate, join, custom]}
      transform_config: {type: str}
      priority: {type: int, gte: 0}
      is_active: {type: bool, default: true}
      created_at: {type: str}
      updated_at: {type: str}
    indexes:
      - {fields: [name], unique: true}
      - {fields: [transform_type]}
      - {fields: [priority]}

  TransformedRecord:
    description: "Data record after transformation"
    fields:
      id: {type: int, primary_key: true}
      source_record_id: {type: int}
      transformed_data: {type: str}
      applied_rules: {type: str}
      transformed_at: {type: str}
      validation_status: {enum: [pending, valid, invalid, skipped], default: pending}
      validation_errors: {type: str, nullable: true}
      created_at: {type: str}
    indexes:
      - {fields: [source_record_id]}
      - {fields: [validation_status]}
      - {fields: [transformed_at]}

  LoadTarget:
    description: "Configuration for a data load destination"
    fields:
      id: {type: int, primary_key: true}
      name: {type: str, unique: true}
      target_type: {enum: [database, data_warehouse, file, api]}
      connection_config: {type: str}
      table_name: {type: str}
      load_mode: {enum: [append, upsert, replace, merge], default: append}
      is_active: {type: bool, default: true}
      created_at: {type: str}
      updated_at: {type: str}
    indexes:
      - {fields: [name], unique: true}
      - {fields: [target_type]}
      - {fields: [is_active]}

  LoadJob:
    description: "Record of a data load operation"
    fields:
      id: {type: int, primary_key: true}
      target_id: {type: int}
      records_loaded: {type: int, gte: 0}
      records_failed: {type: int, gte: 0}
      started_at: {type: str}
      completed_at: {type: str, nullable: true}
      status: {enum: [pending, running, completed, failed, cancelled], default: pending}
      error_message: {type: str, nullable: true}
      created_at: {type: str}
    indexes:
      - {fields: [target_id]}
      - {fields: [status]}
      - {fields: [started_at]}

  ValidationRule:
    description: "Rule for validating transformed data"
    fields:
      id: {type: int, primary_key: true}
      name: {type: str, unique: true}
      rule_type: {enum: [required, type_check, range, regex, custom]}
      field_name: {type: str}
      rule_config: {type: str}
      severity: {enum: [error, warning, info], default: error}
      is_active: {type: bool, default: true}
      created_at: {type: str}
      updated_at: {type: str}
    indexes:
      - {fields: [name], unique: true}
      - {fields: [rule_type]}
      - {fields: [severity]}

  PipelineRun:
    description: "Record of a complete pipeline execution"
    fields:
      id: {type: int, primary_key: true}
      pipeline_name: {type: str}
      source_id: {type: int}
      target_id: {type: int}
      records_extracted: {type: int, gte: 0}
      records_transformed: {type: int, gte: 0}
      records_loaded: {type: int, gte: 0}
      records_failed: {type: int, gte: 0}
      started_at: {type: str}
      completed_at: {type: str, nullable: true}
      status: {enum: [pending, extracting, transforming, loading, completed, failed], default: pending}
      error_message: {type: str, nullable: true}
      created_at: {type: str}
    indexes:
      - {fields: [pipeline_name]}
      - {fields: [source_id]}
      - {fields: [target_id]}
      - {fields: [status]}
      - {fields: [started_at]}

validation:
  strict_mode: true
  fail_fast: false
  generate_contracts: true
