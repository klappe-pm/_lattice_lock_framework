name: API Service CI

on:
  push:
    branches: [main]
    paths:
      - 'pilot_projects/api_service/**'
  pull_request:
    branches: [main]
    paths:
      - 'pilot_projects/api_service/**'

env:
  PYTHON_VERSION: '3.11'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: pilot_projects/api_service
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy

      - name: Run Ruff linter
        run: ruff check src/ tests/

      - name: Run Ruff formatter check
        run: ruff format --check src/ tests/

      - name: Run MyPy type checker
        run: mypy src/ --ignore-missing-imports

  test:
    name: Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: pilot_projects/api_service
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov

      - name: Run tests with coverage
        run: |
          PYTHONPATH=. pytest tests/ -v --cov=src --cov-report=xml --cov-report=term-missing

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          files: pilot_projects/api_service/coverage.xml
          flags: api-service
          name: api-service-coverage

  lattice-validate:
    name: Lattice Lock Validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: pilot_projects/api_service
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Lattice Lock Framework
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jsonschema

      - name: Validate lattice.yaml schema
        run: |
          python -c "
          import yaml
          with open('lattice.yaml', 'r') as f:
              schema = yaml.safe_load(f)
          assert 'version' in schema, 'Missing version'
          assert 'entities' in schema, 'Missing entities'
          print('Schema validation passed')
          "

      - name: Check entity constraints
        run: |
          python -c "
          import yaml
          with open('lattice.yaml', 'r') as f:
              schema = yaml.safe_load(f)
          for entity_name, entity in schema['entities'].items():
              assert 'fields' in entity, f'{entity_name} missing fields'
              assert 'constraints' in entity, f'{entity_name} missing constraints'
              print(f'{entity_name}: OK')
          print('All entity constraints validated')
          "

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: pilot_projects/api_service
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Bandit
        run: pip install bandit

      - name: Run Bandit security scan
        run: bandit -r src/ -ll -ii
